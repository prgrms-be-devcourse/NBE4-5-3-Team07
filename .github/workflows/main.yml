name: CI/CD using GitHub Actions & Docker

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    ### 1. 백엔드 환경변수 파일 생성 (application-secret.yml)
    - name: Create application-secret.yml
      run: |
        echo "${{ secrets.BACKEND_SECRET_YML }}" > ./backend/application-secret.yml

    ### 2. 프론트엔드 환경변수 파일 생성 (.env.production)
    - name: Create .env.production
      run: |
        echo "${{ secrets.FRONTEND_ENV }}" > ./frontend/.env.production

    ### 3. Docker Hub 로그인
    - name: Docker login
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

    ### 4. 백엔드 Docker 이미지 빌드 & 푸시
    - name: Docker build & push - Backend
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/backend-app ./backend
        docker push ${{ secrets.DOCKER_USERNAME }}/backend-app

    ### 5. 프론트엔드 Docker 이미지 빌드 & 푸시
    - name: Docker build & push - Frontend
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend-app ./frontend
        docker push ${{ secrets.DOCKER_USERNAME }}/frontend-app

    ### 6. EC2 접속 및 컨테이너 실행
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          # Docker Hub 로그인
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

          # 기존 컨테이너 중지 및 삭제
          docker stop backend || true && docker rm backend || true
          docker stop frontend || true && docker rm frontend || true

          # 최신 이미지 Pull
          docker pull ${{ secrets.DOCKER_USERNAME }}/backend-app:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/frontend-app:latest

          # 백엔드 실행
          docker run -d --name backend \
            -p 8080:8080 \
            --memory="512m" \
            --memory-swap="1g" \
            ${{ secrets.DOCKER_USERNAME }}/backend-app \
            --spring.profiles.active=prod \
            --spring.config.additional-location=classpath:/application.yml,/app/config/application-secret.yml

          # 프론트엔드 실행
          docker run -d --name frontend \
            -p 3000:3000 \
            ${{ secrets.DOCKER_USERNAME }}/frontend-app

          # 정리
          docker container prune -f
          docker image prune -a -f
