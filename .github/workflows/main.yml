name: CI/CD using GitHub Actions & Docker Compose

on:
  push:
    branches: [ "deploy" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ” ë°±ì—”ë“œ application-secret.yml ìƒì„±
      run: |
        echo "${{ secrets.BACKEND_SECRET_YML }}" > ./backend/src/main/resources/application-secret.yml

    - name: ğŸ” í”„ë¡ íŠ¸ì—”ë“œ .env.production ìƒì„±
      run: |
        echo "${{ secrets.FRONTEND_ENV }}" > ./frontend/.env.production


    - name: ğŸ› ï¸ ë°±ì—”ë“œ JAR ë¹Œë“œ
      working-directory: ./backend
      run: |
        chmod +x ./gradlew
        ./gradlew clean build -x test

    - name: ğŸ³ DockerHub ë¡œê·¸ì¸
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

    - name: ğŸ§± ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/backend-app ./backend
        docker push ${{ secrets.DOCKER_USERNAME }}/backend-app

    - name: ğŸ§± í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend-app ./frontend
        docker push ${{ secrets.DOCKER_USERNAME }}/frontend-app

    - name: ğŸš€ EC2ì— ë°°í¬
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          # í´ë¡  ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ clone, ìˆìœ¼ë©´ pull
          if [ ! -d "NBE4-5-3-Team07" ]; then
            git clone https://github.com/prgrms-be-devcourse/NBE4-5-3-Team07.git
          fi

          cd NBE4-5-3-Team07

          git fetch origin deploy
          git checkout deploy
          git pull origin deploy

          # DockerHub ë¡œê·¸ì¸
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

          # docker-composeë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          docker compose down
          docker compose pull
          docker compose up -d --remove-orphans

          # ì•ˆ ì“°ëŠ” ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ/ë³¼ë¥¨ ì •ë¦¬
          docker system prune -af --volumes
